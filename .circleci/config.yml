version: 2.1

aliases:
  - &upgrade_pip
    name: Upgrades pip
    command: |
      pip install --upgrade pip

defaults: &defaults
  working_directory: ~/algoliasearch-client-python
  parameters:
    version:
      type: string
  docker:
    - image: circleci/python:<< parameters.version >>

jobs:
  test_unit:
    description: Runs unit tests
    <<: *defaults
    steps:
      - checkout
      - run: *upgrade_pip
      - run:
          name: install dependencies
          command: |
            pip install -r requirements/requirements-testing.txt
      - run:
          name: run unit sync tests
          command: |
            sh tests/run_tests_sync.sh
      - run:
          name: run unit async tests
          command: |
            [[ "$(python -V)" =~ "Python 3" ]] || sh tests/run_tests_async.sh

  test_lint:
    description: Runs lint tests
    <<: *defaults
    steps:
      - checkout
      - run: *upgrade_pip
      - run:
          name: install dependencies
          command: |
            pip install -r requirements/requirements-code-style-checker.txt
      - run:
          name: run lint tests
          command: |
            flake8 algoliasearch tests

  test_types:
    description: Runs types tests
    <<: *defaults
    steps:
      - checkout
      - run: *upgrade_pip
      - run:
          name: install dependencies
          command: |
            pip install -r requirements/requirements-static-type-checker.txt
      - run:
          name: run type tests
          command: |
            mypy --config-file mypy.ini -p algoliasearch --disallow-untyped-calls

workflows:
  version: 2
  ci:
    jobs:
      - test_unit:
          version: '2.7'
      - test_unit:
          version: '3.4'
      - test_unit:
          version: '3.5'
      - test_unit:
          version: '3.6'
      - test_unit:
          version: '3.7'
      - test_unit:
          version: '3.8'
      - test_lint:
          version: '3.8'
      - test_types:
          version: '3.8'
